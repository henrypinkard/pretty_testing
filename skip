#!/bin/bash
# Manual test skip management for pretty_testing
# Usage:
#   skip add TEST   - Skip a test (won't run but shows in dashboard)
#   skip rm TEST    - Unskip a test
#   skip list       - List all manually skipped tests
#   skip clear      - Clear all manual skips

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SKIP_FILE="_pretty_testing_/.manual_skip"

mkdir -p _pretty_testing_

case "$1" in
    add)
        if [ $# -lt 2 ]; then
            echo "Usage: skip add TEST_NAME"
            exit 1
        fi
        TEST="$2"
        # Check if already skipped
        if grep -qxF "$TEST" "$SKIP_FILE" 2>/dev/null; then
            echo "Test already skipped: $TEST"
            exit 0
        fi

        # Validate: check if test exists in any test file
        if [ -d "custom_tests" ] && ls custom_tests/*.py >/dev/null 2>&1; then
            test_dir="custom_tests"
        elif [ -d "tests" ] && ls tests/*.py >/dev/null 2>&1; then
            test_dir="tests"
        else
            test_dir=""
        fi

        found=false
        if [ -n "$test_dir" ]; then
            if grep -rq "def ${TEST}[( ]" "$test_dir"/*.py 2>/dev/null; then
                found=true
            fi
        fi

        echo "$TEST" >> "$SKIP_FILE"
        echo "Skipped test: $TEST"
        if [ "$found" = false ]; then
            echo "  Warning: '$TEST' not found in ${test_dir:-test files}. Check the name?"
        fi
        ;;
    rm)
        if [ $# -lt 2 ]; then
            echo "Usage: skip rm TEST_NAME"
            exit 1
        fi
        TEST="$2"
        if [ ! -f "$SKIP_FILE" ]; then
            echo "No tests skipped"
            exit 0
        fi
        if grep -qxF "$TEST" "$SKIP_FILE" 2>/dev/null; then
            grep -vxF "$TEST" "$SKIP_FILE" > "${SKIP_FILE}.tmp"
            mv "${SKIP_FILE}.tmp" "$SKIP_FILE"
            echo "Unskipped test: $TEST"
        else
            echo "Test not found in skip list: $TEST"
        fi
        ;;
    list)
        if [ ! -f "$SKIP_FILE" ] || [ ! -s "$SKIP_FILE" ]; then
            echo "No manually skipped tests"
            exit 0
        fi
        echo "Manually skipped tests:"
        while IFS= read -r test; do
            [ -n "$test" ] && echo "  $test"
        done < "$SKIP_FILE"
        ;;
    clear)
        if [ -f "$SKIP_FILE" ]; then
            rm "$SKIP_FILE"
            echo "All manual skips cleared"
        else
            echo "No skips to clear"
        fi
        ;;
    *)
        echo "Usage: skip {add|rm|list|clear}"
        echo ""
        echo "Commands:"
        echo "  skip add TEST    Skip a test (won't run but shows as [SKIP])"
        echo "  skip rm TEST     Unskip a test"
        echo "  skip list        List all manually skipped tests"
        echo "  skip clear       Clear all manual skips"
        echo ""
        echo "Examples:"
        echo "  skip add test_slow_integration"
        echo "  skip rm test_slow_integration"
        exit 1
        ;;
esac
