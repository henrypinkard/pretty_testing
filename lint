#!/bin/bash
# Static analysis tool - runs pyright, ruff, and custom analyzers

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
bold=$(tput bold)
reset=$(tput sgr0)
blue=$(tput setaf 4)
yellow=$(tput setaf 3)
green=$(tput setaf 2)

# Determine what to analyze
if [ -n "$1" ]; then
    TARGET="$1"
else
    TARGET="."
fi

# Directories to exclude
EXCLUDES="tests,custom_tests,custom,pretty_testing,.git,__pycache__,.venv,venv"

separator() {
    echo ""
    echo "${bold}${blue}═══════════════════════════════════════════════════════════════${reset}"
    echo "${bold}${blue}  $1${reset}"
    echo "${bold}${blue}═══════════════════════════════════════════════════════════════${reset}"
    echo ""
}

# --- PYRIGHT ---
separator "PYRIGHT (Type Checking)"
if command -v pyright &> /dev/null || python3 -c "import pyright" 2>/dev/null; then
    # Pyright uses --ignore for error codes, not directories
    # For directory exclusion, we find python files excluding those dirs
    find "$TARGET" -name "*.py" -type f \
        -not -path "*/tests/*" \
        -not -path "*/custom_tests/*" \
        -not -path "*/custom/*" \
        -not -path "*/pretty_testing/*" \
        -not -path "*/.git/*" \
        -not -path "*/__pycache__/*" \
        -not -path "*/.venv/*" \
        -not -path "*/venv/*" \
        2>/dev/null | xargs python3 -m pyright 2>&1 || true
else
    echo "${yellow}pyright not installed. Run setup.sh or: pip install pyright${reset}"
fi

# --- RUFF ---
separator "RUFF (Linting)"
if command -v ruff &> /dev/null || python3 -c "import ruff" 2>/dev/null; then
    python3 -m ruff check "$TARGET" \
        --exclude "$EXCLUDES" \
        --output-format=full \
        2>&1 || true
else
    echo "${yellow}ruff not installed. Run setup.sh or: pip install ruff${reset}"
fi

# --- CUSTOM ANALYZERS ---
# Add custom static analysis tools here
if [ -f "$REPO_ROOT/custom_lint.sh" ]; then
    separator "CUSTOM CHECKS"
    "$REPO_ROOT/custom_lint.sh" "$TARGET" 2>&1 || true
fi
