#!/bin/bash
# Static analysis tool - runs pyright, ruff, and custom analyzers

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
bold=$(tput bold)
reset=$(tput sgr0)
blue=$(tput setaf 4)
yellow=$(tput setaf 3)
green=$(tput setaf 2)

# Install dependencies on first use
install_if_missing() {
    local pkg="$1"
    if ! python3 -c "import $pkg" 2>/dev/null; then
        echo "${yellow}Installing $pkg (first-time setup)...${reset}"
        pip3 install "$pkg" 2>/dev/null || pip install "$pkg" 2>/dev/null || {
            echo "${yellow}Warning: Failed to install $pkg. Some checks will be skipped.${reset}"
            return 1
        }
    fi
    return 0
}

# Determine what to analyze
if [ -n "$1" ]; then
    TARGET="$1"
else
    TARGET="."
fi

# Directories to exclude
EXCLUDES="tests,test,custom_tests,custom,pretty_testing,static_analysis,.git,__pycache__,.venv,venv,test_*.py,*_test.py"

separator() {
    echo ""
    echo "${bold}${blue}═══════════════════════════════════════════════════════════════${reset}"
    echo "${bold}${blue}  $1${reset}"
    echo "${bold}${blue}═══════════════════════════════════════════════════════════════${reset}"
    echo ""
}

# --- PYRIGHT ---
separator "PYRIGHT (Type Checking)"
if install_if_missing pyright; then
    # Pyright uses --ignore for error codes, not directories
    # For directory exclusion, we find python files excluding those dirs
    find "$TARGET" -name "*.py" -type f \
        -not -path "*/tests/*" \
        -not -path "*/test/*" \
        -not -path "*/custom_tests/*" \
        -not -path "*/custom/*" \
        -not -path "*/pretty_testing/*" \
        -not -path "*/static_analysis/*" \
        -not -path "*/.git/*" \
        -not -path "*/__pycache__/*" \
        -not -path "*/.venv/*" \
        -not -path "*/venv/*" \
        -not -name "test_*.py" \
        -not -name "*_test.py" \
        2>/dev/null | xargs python -m pyright 2>&1 || true
fi

# --- RUFF ---
separator "RUFF (Linting)"
if install_if_missing ruff; then
    # Use ruff.toml config if it exists in static_analysis directory
    RUFF_CONFIG="$REPO_ROOT/static_analysis/ruff.toml"
    if [ -f "$RUFF_CONFIG" ]; then
        python -m ruff check "$TARGET" \
            --config "$RUFF_CONFIG" \
            --exclude "$EXCLUDES" \
            --output-format=full \
            2>&1 || true
    else
        python -m ruff check "$TARGET" \
            --select=B006 \
            --exclude "$EXCLUDES" \
            --output-format=full \
            2>&1 || true
    fi
fi

# --- NUMPY/PYTHON PATTERNS ---
separator "NUMPY/PYTHON PATTERNS"
LINT_SCRIPT="$REPO_ROOT/static_analysis/lint_patterns.py"
if [ -f "$LINT_SCRIPT" ]; then
    python "$LINT_SCRIPT" "$TARGET" 2>&1 || true
else
    echo "${yellow}lint_patterns.py not found at $LINT_SCRIPT${reset}"
fi
