#!/bin/bash
# Remove @traceit_ and @trace decorators from Python files
# Usage: untrace [files/dirs...]   (defaults to all *.py recursively from current dir)

targets=("${@:-.}")
count=0

while IFS= read -r f; do
    [ -f "$f" ] || continue
    # Skip the decorator definition and hook files
    base=$(basename "$f")
    case "$base" in traceit_.py|traceit_hook.py|trace.py) continue ;; esac
    if grep -qE '^\s*@trace(it_)?\b' "$f"; then
        matches=$(grep -cE '^\s*@trace(it_)?\b' "$f")
        # Use grep -v to filter out @traceit_ and @trace lines (portable across macOS/Linux)
        grep -vE '^\s*@trace(it_)?\b' "$f" > "${f}.tmp" && mv "${f}.tmp" "$f"
        echo "  $f: removed $matches @traceit_/@trace line(s)"
        count=$((count + matches))
    fi
done < <(
    for t in "${targets[@]}"; do
        if [ -d "$t" ]; then
            find "$t" -name "*.py" -type f
        elif [ -f "$t" ]; then
            echo "$t"
        fi
    done
)

if [ "$count" -eq 0 ]; then
    echo "No @traceit_ or @trace decorators found."
else
    echo "Removed $count total."
fi
