#!/bin/bash
# Remove @_rtrace decorators from Python files
# Usage: untrace [files/dirs...]   (defaults to all *.py recursively from current dir)

targets=("${@:-.}")
count=0

while IFS= read -r f; do
    [ -f "$f" ] || continue
    # Skip the _rtrace decorator definition itself
    base=$(basename "$f")
    case "$base" in _rtrace.py|_rtrace_hook.py) continue ;; esac
    if grep -qE '^\s*@_rtrace\b' "$f"; then
        matches=$(grep -cE '^\s*@_rtrace\b' "$f")
        # Use grep -v to filter out @_rtrace lines (portable across macOS/Linux)
        grep -vE '^\s*@_rtrace\b' "$f" > "${f}.tmp" && mv "${f}.tmp" "$f"
        echo "  $f: removed $matches @_rtrace line(s)"
        count=$((count + matches))
    fi
done < <(
    for t in "${targets[@]}"; do
        if [ -d "$t" ]; then
            find "$t" -name "*.py" -type f
        elif [ -f "$t" ]; then
            echo "$t"
        fi
    done
)

if [ "$count" -eq 0 ]; then
    echo "No @_rtrace decorators found."
else
    echo "Removed $count total."
fi
