#!/bin/bash
# Emergency debug launcher â€” works independently of w
# Usage: ./dbg tests/some_file.py test_method_name [pudb|pdbpp]
set -e
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
mkdir -p custom

if [ $# -lt 2 ]; then
    echo "Usage: dbg TEST_FILE TEST_METHOD [pudb|pdbpp]"
    echo ""
    echo "Examples:"
    echo "  ./dbg tests/foo.py test_bar          # debug with pudb"
    echo "  ./dbg tests/foo.py test_bar pdbpp    # debug with pdb++"
    echo "  ./dbg custom_tests/foo.py test_bar   # custom test dir"
    exit 1
fi

TEST_FILE="$1"
METHOD="$2"
DEBUGGER="${3:-pudb}"

echo "Generating test file..."
python3 "$REPO_ROOT/test_generator.py" "$TEST_FILE" "$METHOD"

echo "Finding fail line..."
err_out=$(python3 custom/my_test.py 2>&1 || true)
fail_line=$(echo "$err_out" | grep -oP "File \".*my_test.py\", line \K\d+(?=, in $METHOD)" | tail -n 1)
fail_line=${fail_line:-0}

echo "Prepping debugger ($DEBUGGER)..."
python3 "$REPO_ROOT/debug_prep.py" debug custom/my_test.py \
    --method "$METHOD" --fail-line "$fail_line" --debugger "$DEBUGGER"

echo "Launching..."
python3 custom/my_test.py
